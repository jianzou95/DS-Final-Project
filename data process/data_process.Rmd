---
title: "Data process"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(ggridges)
library(ggthemes)


library(stringr)
library(dplyr)
library(forcats)

#embedding plots in rmarkdown
knitr::opts_chunk$set(fig.width=12, fig.height=8, out.width = "80%")
theme_set(theme_bw())
```

First we import the data and clean it.
```{r load_data}
health = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'HEALTH') %>%
  clean_names() %>%
  select(1:7)

restaurant = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'RESTAURANTS') %>%
  clean_names() %>%
  select(1:9, 16:17)

socioeconomic = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'SOCIOECONOMIC') %>%
  clean_names() %>%
  select(1:3, 10:18)

store = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'STORES') %>%
  clean_names() %>%
  select(1:27)

assistance = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'ASSISTANCE') %>%
  clean_names() %>%
  select(1:3,23:24,30:31)

# median household income
medhincome_08 = readxl::read_xls("../mhi_08.xls", range = "A13:B63",col_names = c("state","medhhinc08")) %>%
  clean_names() %>%
  mutate(state = state.abb[match(state,state.name)])
medhincome_08$state[17] = "DC"

medhincome_13 = readxl::read_xls("../mhi_13.xls", range = "A11:B61",col_names = c("state","medhhinc13")) %>%
  clean_names() %>%
  mutate(state = state.abb[match(state,state.name)])
medhincome_13$state[8] = "DC"
medhincome_13$`Income level` = 
  ifelse(medhincome_13$medhhinc13 < 47242.68,"below average",
         ifelse(medhincome_13$medhhinc13 < 58380.28, "middle income", "above average"))
medhincome = merge(medhincome_08, medhincome_13,by=c("state"))
```

### Distribution of obeses and diabetes
We first take a look at the distribution of diabetes and obesity in USA in 2013. Deeper color indicates higher rates of diabety or obetes. Southeastern part has higher diabetes and obesity rates. Especially, Alamba has the highest diabetes and obesity rate. 
```{r}
library(plotly)
health_map = 
  health %>%
  group_by(state) %>%
  summarise(diabetes = mean(pct_diabetes_adults13),
            obesity = mean(pct_obese_adults13)) %>%
  ungroup() %>%
  na.omit() %>%
  mutate(full_state = state.name[match(state, state.abb)],
         hover = with(., paste(full_state, '<br>')))

geo_info <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

plot_geo(health_map, locationmode = 'USA-states') %>%
add_trace(
  z = ~diabetes, text = ~hover, locations = ~state,
  color = ~diabetes, colors = 'OrRd'
) %>%
colorbar(title = "Diabetes Rate (%)") %>%
layout(
  title = 'Adult Diabetes Rate, 2013',
  geo = geo_info
  )


plot_geo(health_map, locationmode = 'USA-states') %>%
add_trace(
  z = ~obesity, text = ~hover, locations = ~state,
  color = ~obesity, colors = 'YlGnBu'
) %>%
colorbar(title = "Obesity Rate (%)") %>%
layout(
  title = 'Adult Obesity Rate, 2013',
  geo = geo_info
  )

```

We then take a look at the distribution of diabetes and obesity nationally.  
Paired t-test results indicates that both diabetes and obesity rate significantlly increase from 2008 to 2013. This conclusion is consist with our literature research. Diabtes and obesity rates keep rising in the past decades in USA.(Mokdad A H, et al., 2001)
```{r}
require(gridExtra)

t_test_diabetes = 
  health %>%
  ggplot() +
  geom_density(aes(x = pct_obese_adults08), color = "#56B4E9", fill ="#56B4E9", alpha = .4) +
  geom_density(aes(x = pct_obese_adults13), color = "#D55E00",fill ="#D55E00", alpha = .4) +
  labs(title = 'Comparisons between the rate of obesity in 2008 and 2013',
       x = 'rate of obesity')

t.test(health$pct_obese_adults08, health$pct_obese_adults13, paired=TRUE)

t_test_obesity = 
  health %>%
  ggplot() +
  geom_density(aes(x = pct_diabetes_adults08), color = "#56B4E9", fill ="#56B4E9", alpha = .4) +
  geom_density(aes(x = pct_diabetes_adults13), color = "#D55E00",fill ="#D55E00", alpha = .4) +
  labs(title = 'Comparisons between the rate of obesity in 2008 and 2013',
       x = 'rate of diabetes')

t.test(health$pct_obese_adults08, health$pct_obese_adults13, paired = TRUE)
t.test(health$pct_diabetes_adults08, health$pct_diabetes_adults13, paired = TRUE)

grid.arrange(t_test_diabetes, t_test_obesity, ncol=2)

```

Finding the similar distribution of diabetes and obesity, we continue to test the relationship between diabetes and obesity in 2008 and 2013 respectively. After the linear regression, we find that there are significant linear relationship between diabetes and obesity both in 2008 and 2013. Around 50% variation of diabetes could be explained by obesity. This conclusion is consistent with other national researches.(Nguyen, et al., 2011)
```{r}
require(gridExtra)

relation_2008 = 
  health %>%
  ggplot() +
  geom_point(aes(x = pct_obese_adults08, y = pct_diabetes_adults08), color="#56B4E9")+
  geom_smooth(aes(x = pct_obese_adults08, y = pct_diabetes_adults08), color="#56B4E9", method = 'lm') +
  labs(title = 'Relationship between the obesity and diabetes rate in 2008',
       x = 'obesity percentage',
       y = 'diabetes percentage')

relation_2013 = 
  health %>%
  ggplot() +
  geom_point(aes(x = pct_obese_adults13, y = pct_diabetes_adults13), color="#D55E00")+
  geom_smooth(aes(x = pct_obese_adults13, y = pct_diabetes_adults13), color="#D55E00", method = 'lm') +
  labs(title = 'Relationship between the obesity and diabetes rate in 2013',
       x = 'obesity percentage',
       y = 'diabetes percentage')
grid.arrange(relation_2008, relation_2013, ncol=2)

summary(lm(pct_diabetes_adults08~pct_obese_adults08, data = health))
summary(lm(pct_diabetes_adults13~pct_obese_adults13, data = health))
```

### Socioeconomic VS diabetes and obesity
```{r}
# extract relavent data
diabetes = health %>%
  group_by(state) %>%
  summarise(pct_08 = mean(pct_diabetes_adults08),
            pct_13 = mean(pct_diabetes_adults13)) %>%
  gather(key = year, value = pct_diabetes_adults, pct_08:pct_13)%>%
  separate(year, into = c("remove", "year"), sep = "_") %>%
  select(-remove)

obese = health %>%
  group_by(state) %>%
  summarise(pct_08 = mean(pct_obese_adults08),
            pct_13 = mean(pct_obese_adults13)) %>%
  gather(key = year, value = pct_obese_adults, pct_08:pct_13)%>%
  separate(year, into = c("remove", "year"), sep = "_") %>%
  select(-remove)

health_status = merge(diabetes, obese, by=c("state", "year"))

income = medhincome %>%
  select(-`Income level`) %>%
  gather(key = year, value = medhhinc, medhhinc08:medhhinc13)%>%
  separate(year, into = c("remove", "year"), sep = -3) %>%
  select(-remove)

eco_health = merge(health_status, income, by=c("state", "year"))
```


```{r}
# income VS obesity
eco_health %>%
  group_by(year) %>%
  ggplot(aes(x = medhhinc, y = pct_obese_adults)) +
  geom_point(aes(color = year), size = 3, alpha = .8) +
  geom_smooth(se = FALSE) + 
  facet_grid(. ~ year) +
  labs( title = "The Association between Median household income and adult obesity rate",
    x = "Median household income(Dollars)",
    y = "Percentage of adult obesity")  +  
  theme(text = element_text(size = 18), 
        axis.text.x = element_text(size = 16), 
        axis.text.y = element_text(size = 16))
```

```{r}
# income VS diabetes
eco_health %>%
  group_by(year) %>%
  ggplot(aes(x = medhhinc, y = pct_diabetes_adults)) +
  geom_point(aes(color = year), size = 3, alpha = .8) +
  geom_smooth(se = FALSE) + 
  facet_grid(. ~ year) +
  labs(title = "The Association between Median household income and adult diabetes rate",
    x = "Median household income(Dollars)",
    y = "Percentage of adult diabetes")  +  
  theme(text = element_text(size = 18), 
        axis.text.x = element_text(size = 16), 
        axis.text.y = element_text(size = 16))
```

```{r}
# fit linear model by segment, cutoff = 60000 dollars
summary(eco_health %>% 
          filter(medhhinc < 60000) %>%
          lm(pct_diabetes_adults ~ medhhinc, data = .))

summary(eco_health %>% 
          filter(medhhinc >= 60000) %>%
          lm(pct_diabetes_adults ~ medhhinc, data = .))
```

### Health related figure
* rate of diabetes increases
```{r}
health %>%
  ggplot() +
  geom_density(aes(x = pct_diabetes_adults08), fill="#56B4E9") +
  geom_density(aes(x = pct_diabetes_adults13), fill="#D55E00") +
  labs(title = 'Comparisons between the rate of diabetes in 2008 and 2013',
       x = 'rate of dabetes')

t.test(health$pct_diabetes_adults08, health$pct_diabetes_adults13)
```

* rate of obesity increases
```{r}
health %>%
  ggplot() +
  geom_density(aes(x = pct_obese_adults08), fill="#56B4E9") +
  geom_density(aes(x = pct_obese_adults13), fill="#D55E00") +
  labs(title = 'Comparisons between the rate of obesity in 2008 and 2013',
       x = 'rate of obesity')

t.test(health$pct_obese_adults08, health$pct_obese_adults13)
```

* Linear relationship between rate of diabety and obesity
```{r}
require(gridExtra)
relation_2008 = 
  health %>%
  ggplot() +
  geom_point(aes(x = pct_diabetes_adults08, y = pct_obese_adults08), color="#56B4E9")+
  geom_smooth(aes(x = pct_diabetes_adults08, y = pct_obese_adults08), color="#56B4E9", method = 'lm') +
  labs(title = 'Relationship between the diabetes rate and obesity rate in 2008',
       x = 'diabetes percentage',
       y = 'obesity percentage')
relation_2013 = 
  health %>%
  ggplot() +
  geom_point(aes(x = pct_diabetes_adults13, y = pct_obese_adults13), color="#D55E00")+
  geom_smooth(aes(x = pct_diabetes_adults13, y = pct_obese_adults13), color="#D55E00", method = 'lm') +
  labs(title = 'Relationship between the diabetes rate and obesity rate in 2013',
       x = 'diabetes percentage',
       y = 'obesity percentage')
grid.arrange(relation_2008, relation_2013, ncol=2)
# summary(lm(pct_diabetes_adults08~pct_obese_adults08, data = health))
```
Here we find that there are linear relationship between diabetes and obesity.

* Compared poverty rate in 2015 with the obesity rate in 2013
```{r}
poverty_health = 
  left_join(health, socioeconomic, by = "fips")

poverty_health %>%
  ggplot(aes(x = povrate15, y = pct_obese_adults13)) +
  geom_point(color = "#56B4E9") +
  labs(title = 'Compared poverty rate in 2015 with the obesity rate in 2013',
       x = 'poverty in 2015',
       y = 'obesity rate in 2013')
```
It seems that data are clustered.  

#### The relationship between diabetes rate and shool breakfast/lunch program participant propotion
In the following section, these two relationships are analyzed:

* The relationship between diabetes rate (2013) and average School Breakfast program (SBP) participation rate(%) (average between 2009 and 2015).
* The relationship between diabetes rate (2013) and National School Lunch Program (NSLP) participation rate(%) (average between 2009 and 2015).

```{r}
participation_rate = assistance %>% 
  group_by(state) %>% 
  mutate(`School Lunch Program` = mean(pct_nslp09, na.rm = T) + mean(pct_nslp15, na.rm = T)) %>% 
  mutate(`School Breakfast Program` = mean(pct_sbp09, na.rm = T) + mean(pct_sbp15, na.rm = T)) %>% 
  ungroup(state) %>% 
  select(state,`School Lunch Program`,`School Breakfast Program`) %>% 
  filter(!(duplicated(state)))

health_13 = health %>% 
  group_by(state) %>% 
  mutate(diabetes_13 = mean(pct_diabetes_adults13, na.rm = T),
         obesites_13 = mean(pct_obese_adults13, na.rm = T)) %>% 
  mutate(statefips = str_sub(fips, 1, 2))%>% 
  filter(!duplicated(state)) %>% 
  ungroup(state) %>%
  select(state, diabetes_13, obesites_13) %>% 
  left_join(participation_rate, by = "state") %>% 
  left_join(medhincome_13, by = "state") %>% 
  gather(key = "program", value = "participant proportion", `School Lunch Program`:`School Breakfast Program`)

#linear regression of diabetes rate and school breakfast/lunch program
broom::tidy(lm(diabetes_13~`participant proportion`, data = health_13[c(1:51),]))
broom::tidy(lm(diabetes_13~`participant proportion`, data = health_13[c(52:102),]))

#scatter plots of the relationship
ggplot(health_13,aes(x = `participant proportion`, y = diabetes_13)) +
  geom_point(aes(color = `Income level`)) +
  geom_smooth(method = "lm",formula = y~x) +
  labs(title = "Diabetes Rate vs. Program Participant",
    x = "Participant Proportion(%)",
    y = "Diabetes Rate(%)") +
  theme(text = element_text(size = 15),
        legend.position = "bottom") +
  facet_grid(. ~program, scales = "free")
```

Note: the "Income level" refers to the level median household income of each state. "Above average" income level is defined as median household income above 75% quantile of all the states. "Below average" income level is defined as median household income below 25% quantile of all the states. "Middle" income is between 25% quantile and 75% quantile.

**Analysis**

The linear relationship between diabetes rate (2013) and average SBP participant proportion or average NSLP participant proportion are both significant with adjusted $R^{2}$ of 38.75% and 24.46% respectively. The results indicate that there is a positive relationship. However, it may be confounded by social and economic status.

From the scatter plot, we can see that most states with below average median household income (green dots) are above the regression line and most states with above average household income (red dots) are below the line. Therefore, income level may differ the relationship between participant proportion and diabetes rate. In those states with lower average household income, for every unit increase in participant proportion, the expected increase in diabetes rate may be higher than states with higher household income.


###Restaurant
* Tidy the dataset
```{r}
compare = left_join(health, restaurant, by="fips")

compare1 = compare %>%
  group_by(state.x) %>%
  summarize(pct_diabetes_adults13 = mean(pct_diabetes_adults13, na.rm = TRUE),
            pct_obese_adults13 = mean(pct_obese_adults13, na.rm = TRUE),
            ffr14 = sum(ffr14),
            ffrpth14 = mean(ffrpth14),
            pc_ffrsales12 = mean(pc_ffrsales12, na.rm = TRUE))
```

* Stepwise Regression
```{r}
mult.fit <- lm(pct_diabetes_adults13 ~ ffr14 + ffrpth14 + pc_ffrsales12, data=compare1)
step(mult.fit, direction='both')
```

* Fit the linear model:
```{r}
lm(pct_diabetes_adults13 ~ ffrpth14 + pc_ffrsales12, data=compare1) %>% summary()
```

* Draw the diagnostics plots
```{r}
lm(pct_diabetes_adults13 ~ ffrpth14 + pc_ffrsales12, data=compare1) %>% plot()
```

* Add a 3d plot
```{r}
library(plotly)


p <- plot_ly(compare1, x = ~ffrpth14, y = ~pc_ffrsales12, z = ~pct_diabetes_adults13, color = ~pct_diabetes_adults13, colors = c('#BF382A', '#0C4B8E')) %>%
  add_markers(text = compare1$state.x) %>%
  layout(scene = list(xaxis = list(title = 'Restaurants per 1000 population'),
                     yaxis = list(title = 'Expenditures per capita'),
                     zaxis = list(title = 'adults diabetes rates in 2013')))
p
```

### fit a model
```{r fit_model}
eco_health
compare1 #ffrpth14 + pc_ffrsales12
lunch_data = health_13[c(1:51),]
colnames(compare1)[1:3] = c("state", "diabetes_13", "obesites_13")
model_data = merge(lunch_data, compare1, by=c("state", "diabetes_13", "obesites_13")) %>%
  select(-`Income level`, - program, - ffr14) %>% 
  filter(medhhinc13 < 60000)
```


```{r}
pairs(model_data %>% select(-state))
cor(model_data %>% select(-state))
```


```{r}
mult.fit.full <- lm(diabetes_13 ~ obesites_13 + medhhinc13 + `participant proportion` + ffrpth14 + pc_ffrsales12, data=model_data)
step(mult.fit.full, direction='both')
lm(formula = diabetes_13 ~ obesites_13 + medhhinc13 + `participant proportion` + 
    ffrpth14 + pc_ffrsales12, data = model_data) %>% summary()
```

```{r}
best <- function(model, ...) 
{
  subsets <- leaps::regsubsets(formula(model), model.frame(model), ...)
  subsets <- with(summary(subsets),
                  cbind(p = as.numeric(rownames(which)), which, rss, rsq, adjr2, cp, bic))
  
  return(subsets)
}  


# Select the 'best' 1 model of all subsets
round(best(mult.fit.full, nbest = 1), 4)
```

```{r}
best_fit = lm(formula = diabetes_13 ~ obesites_13 + medhhinc13 + `participant proportion` + 
    ffrpth14 + pc_ffrsales12, data = model_data)
```

```{r}
influence.measures(best_fit)
par(mar=c(4,4,1,1))
par(mfrow=c(2,2))
plot(best_fit)
```


