---
title: "Data process"
editor_options: 
  chunk_output_type: console
  output:
  html_document: 
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load the dataset we want.
```{r}
library(tidyverse)
library(janitor)
library(ggridges)
library(ggthemes)


library(stringr)
library(dplyr)
library(forcats)

#embedding plots in rmarkdown
knitr::opts_chunk$set(fig.width=12, fig.height=8, out.width = "80%")
theme_set(theme_bw())
```


First we import the data and clean it.
```{r}
health = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'HEALTH') %>%
  clean_names() %>%
  select(1:7)

socioeconomic = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'SOCIOECONOMIC') %>%
  clean_names() %>%
  select(1:3, 10:18)

assistance = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'ASSISTANCE') %>%
  clean_names() %>%
  select(1:3, 23:29)

restaurant = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'RESTAURANTS') %>%
  clean_names() %>%
  select(1:9, 16:17)

county =
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'Supplemental Data - County') %>%
  clean_names()

state =
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'Supplemental Data - State') %>%
  clean_names() %>%
  select(1:2, 9:20, 27:40)

store = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'STORES') %>%
  clean_names() %>%
  select(1:27)

# median household income
medhincome_08 = readxl::read_xls("../mhi_08.xls", range = "A13:B63",col_names = c("state","medhhinc08")) %>%
  clean_names() %>%
  mutate(state = state.abb[match(state,state.name)])
medhincome_13 = readxl::read_xls("../mhi_13.xls", range = "A11:B61",col_names = c("state","medhhinc13")) %>%
  clean_names() %>%
  mutate(state = state.abb[match(state,state.name)])
medhincome = merge(medhincome_08, medhincome_13,by=c("state"))
```

### Socioeconomic VS diabetes and obesity
```{r}
# extract relavent data
diabetes = health %>%
  group_by(state) %>%
  summarise(pct_08 = mean(pct_diabetes_adults08),
            pct_13 = mean(pct_diabetes_adults13)) %>%
  gather(key = year, value = pct_diabetes_adults, pct_08:pct_13)%>%
  separate(year, into = c("remove", "year"), sep = "_") %>%
  select(-remove)

obese = health %>%
  group_by(state) %>%
  summarise(pct_08 = mean(pct_obese_adults08),
            pct_13 = mean(pct_obese_adults13)) %>%
  gather(key = year, value = pct_obese_adults, pct_08:pct_13)%>%
  separate(year, into = c("remove", "year"), sep = "_") %>%
  select(-remove)

health_status = merge(diabetes, obese, by=c("state", "year"))

income = medhincome %>%
  gather(key = year, value = medhhinc, medhhinc08:medhhinc13)%>%
  separate(year, into = c("remove", "year"), sep = -3) %>%
  select(-remove)

eco_health = merge(health_status, income, by=c("state", "year"))
```

```{r}
# plots
# income VS obesity
eco_health %>%
  group_by(year) %>%
  ggplot(aes(x = medhhinc, y = pct_obese_adults)) +
  geom_point(aes(color = year), size = 3, alpha = .8) +
  geom_smooth(se = FALSE) + 
  facet_grid(. ~ year) +
  labs(
    x = "Median household income",
    y = "Percentage of adult obesity")  +  
  theme(text = element_text(size = 16), 
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14))

# income VS diabetes
eco_health %>%
  group_by(year) %>%
  ggplot(aes(x = medhhinc, y = pct_diabetes_adults)) +
  geom_point(aes(color = year), size = 3, alpha = .8) +
  geom_smooth(se = FALSE) + 
  facet_grid(. ~ year) +
  labs(
    x = "Median household income",
    y = "Percentage of adult obesity")  +  
  theme(text = element_text(size = 16), 
        axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14))

```


### Health related figure
* rate of diabetes increases
```{r}
health %>%
  ggplot() +
  geom_density(aes(x = pct_diabetes_adults08), fill="#56B4E9") +
  geom_density(aes(x = pct_diabetes_adults13), fill="#D55E00") +
  labs(title = 'Comparisons between the rate of diabetes in 2008 and 2013',
       x = 'rate of dabetes')

t.test(health$pct_diabetes_adults08, health$pct_diabetes_adults13)
```

* rate of obesity increases
```{r}
health %>%
  ggplot() +
  geom_density(aes(x = pct_obese_adults08), fill="#56B4E9") +
  geom_density(aes(x = pct_obese_adults13), fill="#D55E00") +
  labs(title = 'Comparisons between the rate of obesity in 2008 and 2013',
       x = 'rate of obesity')

t.test(health$pct_obese_adults08, health$pct_obese_adults13)
```

* Linear relationship between rate of diabety and obesity
```{r}
require(gridExtra)
relation_2008 = 
  health %>%
  ggplot() +
  geom_point(aes(x = pct_diabetes_adults08, y = pct_obese_adults08), color="#56B4E9")+
  geom_smooth(aes(x = pct_diabetes_adults08, y = pct_obese_adults08), color="#56B4E9", method = 'lm') +
  labs(title = 'Relationship between the diabetes rate and obesity rate in 2008',
       x = 'diabetes percentage',
       y = 'obesity percentage')
relation_2013 = 
  health %>%
  ggplot() +
  geom_point(aes(x = pct_diabetes_adults13, y = pct_obese_adults13), color="#D55E00")+
  geom_smooth(aes(x = pct_diabetes_adults13, y = pct_obese_adults13), color="#D55E00", method = 'lm') +
  labs(title = 'Relationship between the diabetes rate and obesity rate in 2013',
       x = 'diabetes percentage',
       y = 'obesity percentage')
grid.arrange(relation_2008, relation_2013, ncol=2)
# summary(lm(pct_diabetes_adults08~pct_obese_adults08, data = health))
```
Here we find that there are linear relationship between diabetes and obesity.

* Compared poverty rate in 2015 with the obesity rate in 2013
```{r}
poverty_health = 
  left_join(health, socioeconomic, by = "fips")

poverty_health %>%
  ggplot(aes(x = povrate15, y = pct_obese_adults13)) +
  geom_point(color = "#56B4E9") +
  labs(title = 'Compared poverty rate in 2015 with the obesity rate in 2013',
       x = 'poverty in 2015',
       y = 'obesity rate in 2013')

# summary(lm(pct_obese_adults13~povrate15, data = poverty_health))
```
It seems that data are clustered.  

### Lunch Program in each state
```{r}
#prepare dataset for lunch program
lunch = state[-52,] %>% 
  gather(key = "year", value = "lunch_participants", national_school_lunch_program_participants_fy_2009:national_school_lunch_program_participants_fy_2015) %>% 
  mutate(year = str_replace(year, "national_school_lunch_program_participants_fy_", "")) %>% 
  select(statefips, state, year, lunch_participants) %>% 
  group_by(state) %>% 
  mutate(mean_lunch = mean(lunch_participants)) %>% 
  ungroup(state) %>% 
  mutate(state = fct_reorder(state, mean_lunch))

breakfast = state[-52,] %>% 
  gather(key = "year", value = "breakfast_participants",
         school_breakfast_program_participants_fy_2009:
         school_breakfast_program_participants_fy_2015) %>% 
  mutate(year = str_replace(year, "school_breakfast_program_participants_fy_",""),
         breakfast_participants = as.numeric(breakfast_participants)) %>% 
  select(statefips, state, year, breakfast_participants) %>% 
    group_by(state) %>% 
  mutate(mean_breakfast = mean(breakfast_participants)) %>% 
  ungroup(state) %>% 
  mutate(state = fct_reorder(state, mean_breakfast))

summer = state[-52,] %>% 
  gather(key = "year", value = "summer_participants",
         summer_food_particpants_fy_2009:
         summer_food_participants_fy_2015) %>% 
  mutate(year = str_replace(year, "summer_food_particpants_fy_","")) %>% 
  mutate(year = str_replace(year, "summer_food_participants_fy_","")) %>% 
  select(statefips, state, year, summer_participants) %>% 
  group_by(state) %>% 
  mutate(mean_summer = mean(summer_participants)) %>% 
  ungroup(state) %>% 
  mutate(state = fct_reorder(state, mean_summer))

#Barplot of Average Number of Participants in School Lunch Program (2011-2015)
ggplot(lunch, aes(x = state, y = mean_lunch)) +
  geom_bar(stat = "identity", fill = "blue", alpha = .6) +
  labs(title = "Average Number of Participants in School Lunch Program (2011-2015)",
    x = "state",
    y = "Average number of participants") +
  theme(legend.position = "bottom",
        text = element_text(size = 12),
        axis.text.x = element_text(angle = 90, hjust = 1))

#lunch program and breakfast program
inner_join(lunch,breakfast,)
ggplot()
```

### The relationship between lunch program and diabetes
```{r}
health_13 = health %>% 
  group_by(state) %>% 
  mutate(diabetes_13 = mean(pct_diabetes_adults13, na.rm = T),
         obesites_13 = mean(pct_obese_adults13, na.rm = T)) %>% 
  mutate(statefips = str_sub(fips, 1, 2))%>% 
  filter(!duplicated(state)) %>% 
  ungroup(state) %>% 
  select(statefips, diabetes_13, obesites_13) %>% 
  left_join(state, by = "statefips") %>% 
  rename(lunch_2009 = "national_school_lunch_program_participants_fy_2009",
         lunch_2011 = "national_school_lunch_program_participants_fy_2011",
         lunch_2012 = "national_school_lunch_program_participants_fy_2012",
         lunch_2013 = "national_school_lunch_program_participants_fy_2013") %>% 
  select(statefips, state, diabetes_13, obesites_13, lunch_2009, lunch_2011, lunch_2012, lunch_2013)

#linear regression: diabetes_13 v.s. lunch participants (2013)
summary(lm(diabetes_13 ~ log(lunch_2013), data  = health_13))
```
