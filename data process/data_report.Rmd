---
title: "Health Status and Food Environment"
author: "Group 9"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

library(tidyverse)
library(janitor)
library(ggridges)
library(ggthemes)
library(stringr)
library(dplyr)
library(forcats)
library(plotly)

theme_set(theme_bw())
theme_update(legend.position = "bottom")
```

## Introduction
Diabetes is a chronic disease whose prevalence has increased rapidly in the past few decades. According to the report from WHO, in 2014, the prevalence of diabetes among adult population had risen from 4.7% to 8.5%  comparing to that in 1980 (WHO, 2016). It is projected as the seventh leading cause of mortality in 2030 (Mathers & Loncar, 2006).  

In the U.S., the data of 2015 shows that 7.2% of the population are diagnosed with Diabetes(CDC, 2017). In 2013, it ranked as the seventh leading cause of  death in the nation (CDC). Previous studies identified obesity as the main risk factor of  type 2 diabetes (which account for 95% cases of diabetes in the U.S.)(Smyth & Heron, 2006). Meanwhile,  consumption of artificial sweetened beverage(Koning et al, 2011) and  prenatal exposure to famine under certain circumstances(Lumey, Khalangot & Vaiserman, 2015) are both related to the increased prevalence of type 2 diabetes. The report from CDC also demonstrates that there are certain association between socioeconomic status and the prevalence(CDC, 2017). 

Inspiring by these findings which are all somehow related to food accessibility, we want to explore the association between food related factors, including â€¦â€?, and the prevalence of diabetes in the US. Over the course of the exploration of the data, we further want to build a model to explain the relationship between food related factors and the prevalence of Diabetes.

## Data and Method
The dataset we would like to use is <B>Food Environment Atlas</B> which can be found on [data.gov](https://catalog.data.gov/dataset/food-environment-atlas-f4a22).The detailed description of the dataset can be found on the [Github page](https://github.com/jianzou95/DS-Final-Project/blob/master/archived_documentation_August2015.pdf) of the project The dataset describes food environment factors of each state, including:  

* Rate of diabetes and obesity in every counties in 2008 and 2013.
* Participation percentage of National School Lunch Program and School Breakfast Program.


In addition to this main dataset, we also use another two dataset, <B>Median Household Income (In 2013 Inflation-adjusted Dollars)</B> by [State Ranked](https://www.census.gov/data/tables/2014/demo/income-poverty/p60-249.html) from Highest to Lowest Using 3-Year Average (2011-2013), and  <B>Median Household Income (In 2008 Inflation-adjusted Dollars)</B> by [State Ranked](https://www.census.gov/data/tables/2009/demo/income-poverty/p60-236.html.) from Highest to Lowest Using 3-Year Average: 2006-2008 from census.gov. 

The two median household income datasets contain the information of median household income of each state (50 states and DC) in 2008 and 2013 collected by U.S. Census Bureau. The income values are evened in a three-year-period (ie. 2006-2008 for 2008, and 2011-2013 for 2013) and adjusted for inflation. 

All datasets are downloaded directly from the websites as Excel format. 

```{r data_import}
health = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'HEALTH') %>%
  clean_names() %>%
  select(1:7)

socioeconomic = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'SOCIOECONOMIC') %>%
  clean_names() %>%
  select(1:3, 10:18)

assistance = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'ASSISTANCE') %>%
  clean_names() %>%
  select(1:3, 23:24, 30:31)

restaurant = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'RESTAURANTS') %>%
  clean_names() %>%
  select(1:9, 16:17)

county =
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'Supplemental Data - County') %>%
  clean_names()

state =
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'Supplemental Data - State') %>%
  clean_names() %>%
  select(1:2, 9:20, 27:40)

store = 
  readxl::read_xls('../food_enviroment_atlas.xls', sheet = 'STORES') %>%
  clean_names() %>%
  select(1:27)


medhincome_08 = readxl::read_xls("../mhi_08.xls", range = "A13:B63",col_names = c("state","medhhinc08")) %>%
  clean_names() %>%
  mutate(state = state.abb[match(state,state.name)])
medhincome_08$state[17] = "DC"

medhincome_13 = readxl::read_xls("../mhi_13.xls", range = "A11:B61",col_names = c("state","medhhinc13")) %>%
  clean_names() %>%
  mutate(state = state.abb[match(state,state.name)])
medhincome_13$state[8] = "DC"
medhincome_13$`income level` = 
  ifelse(medhincome_13$medhhinc13 < 47242.68,"below average",
         ifelse(medhincome_13$medhhinc13 < 58380.28, "middle income", "above average"))

medhincome = merge(medhincome_08, medhincome_13,by=c("state"))
```
 
## Results
We first provide a overview of the data about diabetes and obesity, then we link those health related data to other possible predictors, such as socioeconomic status, number of fast-food restaurants, National School Lunch Program (NSLP)/School Breakfast Program (SBP) and so on.

### National diabetes and obesity data in 2008 and 2013
We first take a look at the distribution of diabetes and obesity in USA in 2013. Deeper color indicates higher rates of diabetes or obesity. Southeastern part has higher diabetes and obesity rates.  
```{r map}
health_map = 
  health %>%
  group_by(state) %>%
  summarise(diabetes = mean(pct_diabetes_adults13),
            obesity = mean(pct_obese_adults13)) %>%
  ungroup() %>%
  na.omit() %>%
  mutate(full_state = state.name[match(state, state.abb)],
         hover = with(., paste(full_state, '<br>')))

geo_info <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

plot_geo(health_map, locationmode = 'USA-states') %>%
add_trace(
  z = ~diabetes, text = ~hover, locations = ~state,
  color = ~diabetes, colors = 'OrRd'
) %>%
colorbar(title = "Diabetes Rate (%)") %>%
layout(
  title = 'Adult Diabetes Rate, 2013',
  geo = geo_info
  )

plot_geo(health_map, locationmode = 'USA-states') %>%
add_trace(
  z = ~obesity, text = ~hover, locations = ~state,
  color = ~obesity, colors = 'YlGnBu'
) %>%
colorbar(title = "Obesity Rate (%)") %>%
layout(
  title = 'Adult Obesity Rate, 2013',
  geo = geo_info
  )
```
We then take a look at the distribution of diabetes and obesity nationally.Paired t-test results indicates that both diabetes and obesity rate significantlly increase from 2008 to 2013. This conclusion is consist with our literature research. Diabtes and obesity rates keep rising in the past decades in USA.(Mokdad A H, et al., 2001)
```{r diabetes_obesities_overyear, warning = FALSE, message = FALSE}
require(gridExtra)
t_test_diabetes = 
  health %>%
  ggplot() +
  geom_density(aes(x = pct_obese_adults08), color = "#56B4E9", fill ="#56B4E9", alpha = .4) +
  geom_density(aes(x = pct_obese_adults13), color = "#D55E00",fill ="#D55E00", alpha = .4) +
  labs(title = 'Obesity rate in 08 and 13',
       x = 'rate of obesity')

t_test_obesity = 
  health %>%
  ggplot() +
  geom_density(aes(x = pct_diabetes_adults08), color = "#56B4E9", fill ="#56B4E9", alpha = .4) +
  geom_density(aes(x = pct_diabetes_adults13), color = "#D55E00",fill ="#D55E00", alpha = .4) +
  labs(title = 'Diabetes rate in 08 and 13',
       x = 'rate of diabetes')

grid.arrange(t_test_diabetes, t_test_obesity, ncol=2)

t.test(health$pct_obese_adults08, health$pct_obese_adults13, paired = TRUE) 
t.test(health$pct_diabetes_adults08, health$pct_diabetes_adults13, paired = TRUE)
```
Finding the similar distribution of diabetes and obesity, we continue to test the relationship between diabetes and obesity in 2008 and 2013 respectively. After the linear regression, we find that there are significant linear relationship between diabetes and obesity both in 2008 and 2013. Around 50% variation of diabetes could be explained by obesity. This conclusion is consistent with other national researches.(Nguyen, et al., 2011)
```{r relationship_dibetes_obesity, message = FALSE, warning = FALSE}
require(gridExtra)

relation_2008 = 
  health %>%
  ggplot() +
  geom_point(aes(x = pct_obese_adults08, y = pct_diabetes_adults08), color="#56B4E9")+
  geom_smooth(aes(x = pct_obese_adults08, y = pct_diabetes_adults08), color="#56B4E9", method = 'lm') +
  labs(title = 'Obesity and Diabetes relation in 2008',
       x = 'obesity percentage',
       y = 'diabetes percentage')

relation_2013 = 
  health %>%
  ggplot() +
  geom_point(aes(x = pct_obese_adults13, y = pct_diabetes_adults13), color="#D55E00")+
  geom_smooth(aes(x = pct_obese_adults13, y = pct_diabetes_adults13), color="#D55E00", method = 'lm') +
  labs(title = 'Obesity and Diabetes relation in 2013',
       x = 'obesity percentage',
       y = 'diabetes percentage')
grid.arrange(relation_2008, relation_2013, ncol=2)

lm(pct_diabetes_adults08~pct_obese_adults08, data = health) %>% summary()
lm(pct_diabetes_adults13~pct_obese_adults13, data = health) %>% summary()
```

### The relationship between diabetes rate and school breakfast/lunch program participant propotion

In the following section, these two relationships are analyzed:

* The relationship between diabetes rate (2013) and average School Breakfast program (SBP) participation rate(%) (average between 2009 and 2015).
* The relationship between diabetes rate (2013) and National School Lunch Program (NSLP) participation rate(%) (average between 2009 and 2015).
```{r diabetes_SBP_relation}
participation_rate = assistance %>% 
  group_by(state) %>% 
  mutate(`School Lunch Program` = mean(pct_nslp09, na.rm = T) + mean(pct_nslp15, na.rm = T)) %>% 
  mutate(`School Breakfast Program` = mean(pct_sbp09, na.rm = T) + mean(pct_sbp15, na.rm = T)) %>% 
  ungroup(state) %>% 
  select(state,`School Lunch Program`,`School Breakfast Program`) %>% 
  filter(!(duplicated(state)))

health_13 = health %>% 
  group_by(state) %>% 
  mutate(diabetes_13 = mean(pct_diabetes_adults13, na.rm = T),
         obesites_13 = mean(pct_obese_adults13, na.rm = T)) %>% 
  mutate(statefips = str_sub(fips, 1, 2))%>% 
  filter(!duplicated(state)) %>% 
  ungroup(state) %>%
  select(state, diabetes_13, obesites_13) %>% 
  left_join(participation_rate, by = "state") %>% 
  left_join(medhincome_13, by = "state") %>% 
  gather(key = "program", value = "participant proportion", `School Lunch Program`:`School Breakfast Program`)

#linear regression of diabetes rate and school breakfast/lunch program
broom::tidy(lm(diabetes_13~`participant proportion`, data = health_13[c(1:51),]))
broom::tidy(lm(diabetes_13~`participant proportion`, data = health_13[c(52:102),]))

ggplot(health_13,aes(x = `participant proportion`, y = diabetes_13)) +
  geom_point(aes(color = `income level`)) +
  geom_smooth(method = "lm",formula = y~x) +
  labs(title = "Diabetes Rate vs. Program Participant",
    x = "Participant Proportion(%)",
    y = "Diabetes Rate(%)") +
  theme(text = element_text(size = 15),
        legend.position = "bottom") +
  facet_grid(. ~program, scales = "free")
```  

**Note:** the ¡°Income level¡± refers to the level median household income of each state. ¡°Above average¡± income level is defined as median household income above 75% quantile of all the states. ¡°Below average¡± income level is defined as median household income below 25% quantile of all the states. ¡°Middle¡± income is between 25% quantile and 75% quantile.

**Analysis:** The linear relationship between diabetes rate (2013) and average SBP participant proportion or average NSLP participant proportion are both significant with adjusted $R^{2}$ of 38.75% and 24.46% respectively. The results indicate that there is a positive relationship. However, it may be confounded by social and economic status.

From the scatter plot, we can see that most states with below average median household income (green dots) are above the regression line and most states with above average household income (red dots) are below the line. Therefore, income level may differ the relationship between participant proportion and diabetes rate. In those states with lower average household income, for every unit increase in participant proportion, the expected increase in diabetes rate may be higher than states with higher household income.


## Reference
* Centers for Disease Control and Prevention. "[National diabetes statistics report: estimates of diabetes and its burden in the United States, 2017.](https://www.cdc.gov/diabetes/pdfs/data/statistics/national-diabetes-statistics-report.pdf)" Atlanta, GA: National Center for Chronic Disease Prevention and Health Promotion .

* Mathers, Colin D., and Dejan Loncar. "[Projections of global mortality and burden of disease from 2002 to 2030.](http://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.0030442)" PLoS medicine 3.11 (2006): e442.

* Mokdad, Ali H., et al. "[The continuing epidemics of obesity and diabetes in the United States.]()" Jama 286.10 (2001): 1195-1200.

* Nguyen, Ninh T., et al. "[Relationship between obesity and diabetes in a US adult population: findings from the National Health and Nutrition Examination Survey, 1999-2006.](https://link.springer.com/content/pdf/10.1007%2Fs11695-010-0335-4.pdf)" Obesity surgery 21.3 (2011): 351-355.

* Smyth, Simon, and Andrew Heron. "[Diabetes and obesity: the twin epidemics.](https://www.nature.com/articles/nm0106-75)" Nature medicine 12.1 (2006): 75-80.

* World Health Organization. [Global report on diabetes](http://apps.who.int/iris/bitstream/10665/204871/1/9789241565257_eng.pdf?ua=1). World Health Organization, 2016.  



